---
title: "Untitled"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)

aflTables <- readRDS(file = "data/aflTables_1995_2022.RDS")

Rnds = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22","23","24","EF", "QF","SF", "PF", "GF")

```

## Create shared experience table

```{r}
shared_experience_tbl <- 
  aflTables %>% 
  transmute(season = Season,
            round = Round,
            teamName = Playing.for,
            playerId = ID) %>% 
  {full_join(.,.,by = c("season", "round", "teamName"))} %>% 
  filter(playerId.x < playerId.y) %>% 
  mutate(player_cross = paste(playerId.x, playerId.y, sep = "_"),
         round = factor(round, levels = Rnds, ordered = T)) %>% 
  count(season,teamName,playerId.x, playerId.y,round) %>% 
  arrange(teamName,season,round) %>% 
  group_by(playerId.x, playerId.y) %>% 
  mutate(shared_exp = cumsum(n)) %>% 
  ungroup() %>% 
  count(season, teamName,round, wt = shared_exp) %>% 
  group_by(season, teamName) %>% 
  slice_max(n,n = 1) %>% 
  ungroup()

player_combinations <- 
  aflTables %>% 
  transmute(season = Season,
            round = factor(Round, levels = Rnds, ordered = T),
            teamName = Playing.for,
            playerId = ID) %>% 
  arrange(season, round, teamName, playerId) %>%
  {full_join(.,.,by = c("season", "round", "teamName"))} %>% 
  filter(playerId.x < playerId.y) %>% 
  mutate(player_cross = paste(playerId.x, playerId.y, sep = "_")) %>% 
  count(season, teamName, playerId.x, playerId.y, round) %>% 
  arrange(teamName,season,round) %>% 
  group_by(playerId.x, playerId.y) %>% 
  mutate(shared_exp = cumsum(n)) %>% 
  ungroup()
```  


```{r}
shared_experience_tbl %>% 
ggplot(aes(x = season, y = n,group = teamName)) +
  geom_point(col = "grey60") +
  geom_line(col = "grey60") +
  geom_point(data = ~filter(.,teamName == "Geelong"), aes(col = "Geelong"), size = 3) +
  geom_line(data = ~filter(.,teamName == "Geelong"), aes(col = "Geelong"), size = 1.3) +
  geom_point(data = ~filter(.,teamName == "Greater Western Sydney"), aes(col = "Greater Western Sydney"), size = 3) +
  geom_line(data = ~filter(.,teamName == "Greater Western Sydney"), aes(col = "Greater Western Sydney"), size = 1.3) +
  geom_point(data = ~filter(.,teamName == "Gold Coast"), aes(col = "Gold Coast"), size = 3) +
  geom_line(data = ~filter(.,teamName == "Gold Coast"), aes(col = "Gold Coast"), size = 1.3) +
  theme_bw() +
  expand_limits(y = 0) +
  coord_cartesian(xlim = c(2005,2022)) +
  scale_colour_manual(values = c("Greater Western Sydney" = "#FF7F00", "Geelong" = "#00008B", "Gold Coast" = "gold")) +
  scale_x_continuous(breaks = seq(2005,2020,5),
                     minor_breaks = 2005:2022) + 
  labs(title = "Team shared experience",
       subtitle = "Maximum shared experience during given season for teams from 2005 - 2022",
       y = "Shared experience",
       x = "Season",
       colour = "2022 grand finalists",
       caption = 'data: FitzRoy/AFLTables\nConcept derrived from 2018 book "Footballistics"') +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1),
        legend.position = "bottom")
```

The most any team can increase their team shared experience is if the same 23 players
  play in every game throughout the season and into the finals. The theoretical maximum
  is calculated by (assuming a 23 person game-day squad) 23 choose 2 mulitplied
  by the total number of games played by a team during the season. This total is approximately 7000 shared experience.

```{r}
shared_experience_tbl %>% 
  filter(teamName %in% c( "Greater Western Sydney","Gold Coast"),season >= 2011) %>%
  ggplot(aes(x = factor(season), y = n)) +
  geom_col(aes(fill = teamName), position = position_identity(), alpha = 0.6, col = "black") +
  geom_text(aes(label = scales::comma(n)),hjust = 0.5,nudge_y = -400,col = "white") +
  scale_fill_manual(values = c("Greater Western Sydney" = "#FF7F00", "Gold Coast" = "red")) +
  theme_bw() +
  labs(title = "Expansion temas growth in shared experience: 2012 - 2022",
       subtitle = "GWS and Gold Coast",
       x = "Season",
       y = "Shared experience",
       fill = "",
       caption = 'data: FitzRoy/AFLTables"') +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1),
        legend.position = "bottom")
```

## 2016-2019 GWS player movements

```{r}
player_combinations %>% 
  ungroup() %>% 
  #filter(teamName == "Greater Western Sydney", season %in% 2014:2022) %>% 
  filter(teamName %in% c( "Greater Western Sydney","Gold Coast"),season >= 2011) %>%
  count(teamName, season, round, wt = shared_exp) %>%
  ggplot(aes(x = round, y = n)) +
  geom_col() +
  geom_hline(data = ~group_by(.,teamName, season) %>% summarise(n = mean(n,na.rm = T)),
             aes(yintercept = n, col = "Season ave shared exp"),
             linetype = 2) +
  theme_bw() +
  labs(title = "In-season shared experience",
       subtitle = "Total shared experience during each round; 2017-2019",
       x = "",
       y = "Shared experience",
       colour = "",
       fill = "",
       caption = 'data: FitzRoy/AFLTables"') +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 1),
        axis.text.x = element_blank(),
        legend.position = "bottom") +
  scale_colour_manual(values = "black") +
  facet_grid(teamName~season)
```

## Player movement

```{r}
aflTables %>% 
  filter(Playing.for %in% c("Geelong", "Greater Western Sydney", "Gold Coast"), Season %in% 2015:2022) %>% 
  distinct(Playing.for, ID, Season, full_name = paste(First.name,Surname)) %>% 
  group_by(Playing.for, ID) %>% 
  mutate(last_ssn = if_else(max(Season) == Season,"Leave","Stay")) %>% 
  filter(Season < 2022) %>% 
  ungroup() %>% 
  count(Playing.for, Season,last_ssn) %>% 
  mutate(n = if_else(last_ssn == "Leave",-n,n)) %>% 
  ggplot(aes(Season,n, fill = last_ssn)) +
  geom_col() + 
  facet_wrap(~Playing.for)
```




```{r}
max_se <- 
  player_combinations %>% 
  filter(teamName == "Greater Western Sydney", season %in% 2017:2018) %>% 
  left_join(aflTables %>%
              transmute(ID,full_name.x = paste(First.name,Surname)) %>%
              distinct(ID,.keep_all = T), by = c("playerId.x" = "ID")) %>% 
  left_join(aflTables %>%
              transmute(ID,full_name.y = paste(First.name,Surname)) %>%
              distinct(ID,.keep_all = T), by = c("playerId.y" = "ID")) %>% 
  mutate(crossId = paste(full_name.x, full_name.y, sep = " - ")) %>% 
  group_by(season, crossId) %>% 
  slice_max(shared_exp,n = 1) %>% 
  ungroup()
```

```{r}
GWS_leavers_2017 <- aflTables %>% 
filter(Playing.for == "Greater Western Sydney", Season %in% 2017:2018) %>% 
  distinct(ID,Season,full_name = paste(First.name,Surname)) %>% 
  group_by(ID) %>% 
  mutate(last_ssn = if_else(max(Season) < 2018,"Leave","Stay")) %>% 
  ungroup() %>% 
  filter(Season == 2017,last_ssn == "Leave") %>% 
  distinct(ID,full_name) %>% 
  pull(ID)

max_se %>% 
  filter(season == 2017) %>% 
  group_by(playerId.x,playerId.y) %>% 
  mutate(leaver = case_when(
    playerId.x %in% GWS_leavers_2017 & playerId.y %in% GWS_leavers_2017 ~ paste(full_name.x,full_name.y, sep = " and "),
    playerId.x %in% GWS_leavers_2017 ~ full_name.x,
    playerId.y %in% GWS_leavers_2017 ~ full_name.y,
    TRUE ~ "Staying"),
         shared_dir = if_else(leaver != "Staying",-shared_exp,shared_exp)) %>%
  ungroup() %>% 
  add_count(leaver, wt = shared_exp) %>% 
  filter(shared_dir < -30) %>%
  ggplot(aes(x = shared_dir, y = fct_reorder(crossId, -shared_dir), fill = fct_reorder(leaver,-nn))) + 
  geom_col() +
  scale_fill_brewer(palette = "Set3")
```

## Individual players


```{r}

```

## Season 2022

```{r}
player_combinations %>% 
  filter(teamName == "Greater Western Sydney", season == 2022) %>% 
  group_by(season,round) %>% 
  mutate(rnd_exp = sum(shared_exp)) %>% 
  group_by(season) %>% 
  slice_max(rnd_exp,n = 1) %>% 
  ungroup() %>% 
  arrange(-shared_exp) %>%
  left_join(aflTables %>%
              transmute(ID,full_name.x = paste(First.name,Surname)) %>%
              distinct(ID,.keep_all = T), by = c("playerId.min" = "ID")) %>% 
  left_join(aflTables %>%
              transmute(ID,full_name.y = paste(First.name,Surname)) %>%
              distinct(ID,.keep_all = T), by = c("playerId.max" = "ID")) %>%
  ggplot(aes(x = full_name.x, y = full_name.y, fill = shared_exp)) + 
  geom_tile() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust = 1))

```


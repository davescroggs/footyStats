---
title: "First model"
output: github_document
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(tidymodels)
library(glmnet)

#doParallel::registerDoParallel(core = 4)

load(file = here("data/processed_data.RData"))

playerData <- playerData %>% 
  filter(season < 2022, round <= 23,!is.na(ratingPoints)) %>% 
  mutate(brownlowVotes = factor(if_else(brownlowVotes > 0,"Vote","No_vote")),
         full_name = paste(givenName,surname))
```

# First

This is a first model to get a feel for how a predictive model might produce results. Early observations show that a lot of the stats that are often discussed along with Brownlow votes (clearances, goals etc.) tend to be correlated with Brownlow votes. For a first, simple model, Lasso regression will be used to predict the probability of any vote. Votes will be allocated to the players in a given match that have the 3 highest estimated probability of gaining votes in that round, with the highest probability getting 3 votes, second most getting 2 etc. 

## Data splitting

```{r}
brownlowSplit <- initial_split(playerData,prop = 0.75,strata = brownlowVotes)

brownlowTest <- testing(brownlowSplit)
brownlowTrain <- training(brownlowSplit)

brownlowCV <- vfold_cv(brownlowTrain,v = 5,strata = brownlowVotes)

```


## Preprocessing

```{r}
brnlw_rec <- recipe(brownlowVotes ~ centreClearances + goals + totalClearances + stoppageClearances + shotsAtGoal + marksInside50 + goalAssists + ratingPoints + inside50S + goalAccuracy, data = brownlowTrain) %>% 
  step_impute_median(all_predictors())
  themis::step_smote(brownlowVotes)
```

## Workflow and model spec

```{r}
lin_wf <- workflow() %>%
  add_recipe(brnlw_rec) %>%
  add_model(logistic_reg(penalty = tune()) %>%
              set_engine("glmnet"))
```

## Fit model

```{r}
grid_control <- control_grid(save_pred = TRUE,
                             save_workflow = TRUE,
                             extract = extract_model)

lin_tune <- lin_wf %>%
  tune_grid(brownlowCV,
            grid = crossing(penalty = 10 ^ seq(-6, -.5, .1)),
            metrics = metric_set(accuracy,f_meas,mn_log_loss,precision,recall),
            control = grid_control)

lin_tune %>% 
  autoplot()

lin_tune %>% 
  conf_mat()
```

